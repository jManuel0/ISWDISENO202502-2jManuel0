<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Actividades - Voluntariado</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f6fa; min-height: 100vh; }
        body.dark-mode { background: #1a1a2e; color: #eee; }
        nav { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        body.dark-mode nav { background: #16213e; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #667eea; }
        .nav-links { display: flex; align-items: center; gap: 1.5rem; }
        .nav-links a { text-decoration: none; color: #333; font-weight: 500; }
        body.dark-mode .nav-links a { color: #ddd; }
        .nav-links a:hover { color: #667eea; }
        .btn-logout { padding: 0.5rem 1rem; background: #ff4757; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .main-content { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .calendar-header h1 { color: #333; font-size: 1.8rem; }
        body.dark-mode .calendar-header h1 { color: #eee; }
        .calendar-nav { display: flex; gap: 1rem; align-items: center; }
        .calendar-nav button { padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .calendar-nav button:hover { background: #5a6fd6; }
        .month-year { font-size: 1.3rem; font-weight: 600; min-width: 200px; text-align: center; }
        .calendar-container { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 2px 15px rgba(0,0,0,0.08); }
        body.dark-mode .calendar-container { background: #16213e; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day-header { padding: 1rem; text-align: center; font-weight: 600; color: #666; background: #f8f9fa; }
        body.dark-mode .day-header { background: #0f3460; color: #bbb; }
        .calendar-day { min-height: 120px; padding: 0.5rem; background: #fff; border: 1px solid #eee; position: relative; transition: all 0.3s; }
        body.dark-mode .calendar-day { background: #1a1a2e; border-color: #0f3460; }
        .calendar-day:hover { background: #f8f9fa; }
        body.dark-mode .calendar-day:hover { background: #0f3460; }
        .calendar-day.other-month { background: #f5f6fa; color: #aaa; }
        body.dark-mode .calendar-day.other-month { background: #0f3460; }
        .calendar-day.today { border: 2px solid #667eea; }
        .day-number { font-weight: 600; margin-bottom: 0.5rem; color: #333; }
        body.dark-mode .day-number { color: #eee; }
        .calendar-day.other-month .day-number { color: #aaa; }
        .event { padding: 0.3rem 0.5rem; margin-bottom: 0.3rem; border-radius: 5px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: transform 0.2s; }
        .event:hover { transform: scale(1.02); }
        .event.educacion { background: #e8f0fe; color: #1a73e8; }
        .event.salud { background: #fce8e6; color: #d93025; }
        .event.medio_ambiente { background: #e6f4ea; color: #137333; }
        .event.social { background: #fef7e0; color: #f9ab00; }
        .event.cultural { background: #f3e8fd; color: #8e24aa; }
        .event.default { background: #e0e0e0; color: #333; }
        .legend { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
        .legend-color { width: 20px; height: 20px; border-radius: 5px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 15px; max-width: 500px; width: 90%; }
        body.dark-mode .modal-content { background: #16213e; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h3 { font-size: 1.3rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .event-details p { margin-bottom: 0.8rem; color: #666; }
        body.dark-mode .event-details p { color: #bbb; }
        .event-details strong { color: #333; }
        body.dark-mode .event-details strong { color: #eee; }
        .btn-inscribirse { width: 100%; padding: 1rem; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 1rem; }
        .btn-inscribirse:hover { background: #5a6fd6; }
        .view-toggle { display: flex; gap: 0.5rem; }
        .view-toggle button { padding: 0.5rem 1rem; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; cursor: pointer; }
        .view-toggle button.active { background: #667eea; color: white; }
        body.dark-mode .view-toggle button { background: #1a1a2e; }
        @media (max-width: 768px) {
            .calendar-day { min-height: 80px; }
            .event { font-size: 0.65rem; padding: 0.2rem 0.3rem; }
            .calendar-header { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="logo">Voluntariado ONG</div>
        <div class="nav-links">
            <a href="/dashboard">Dashboard</a>
            <a href="/actividades">Actividades</a>
            <a href="/calendario">Calendario</a>
            <a href="/perfil">Mi Perfil</a>
            <button class="btn-logout" onclick="logout()">Cerrar sesion</button>
        </div>
    </nav>

    <div class="main-content">
        <div class="calendar-header">
            <h1>Calendario de Actividades</h1>
            <div class="calendar-nav">
                <button onclick="prevMonth()">◀ Anterior</button>
                <span class="month-year" id="monthYear"></span>
                <button onclick="nextMonth()">Siguiente ▶</button>
            </div>
        </div>

        <div class="calendar-container">
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background:#e8f0fe"></div>Educacion</div>
            <div class="legend-item"><div class="legend-color" style="background:#fce8e6"></div>Salud</div>
            <div class="legend-item"><div class="legend-color" style="background:#e6f4ea"></div>Medio Ambiente</div>
            <div class="legend-item"><div class="legend-color" style="background:#fef7e0"></div>Social</div>
            <div class="legend-item"><div class="legend-color" style="background:#f3e8fd"></div>Cultural</div>
        </div>
    </div>

    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="eventTitle">Evento</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="event-details">
                <p><strong>Categoria:</strong> <span id="eventCategory"></span></p>
                <p><strong>Fecha:</strong> <span id="eventDate"></span></p>
                <p><strong>Ubicacion:</strong> <span id="eventLocation"></span></p>
                <p><strong>Descripcion:</strong> <span id="eventDescription"></span></p>
                <p><strong>Voluntarios:</strong> <span id="eventVolunteers"></span></p>
            </div>
            <button class="btn-inscribirse" id="btnInscribirse" onclick="inscribirse()">Inscribirme</button>
        </div>
    </div>

    <script>
        const API_URL = globalThis.location.origin;
        const token = localStorage.getItem('token');
        let currentDate = new Date();
        let activities = [];
        let selectedActivity = null;

        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const dayNames = ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'];

        async function loadActivities() {
            try {
                const response = await fetch(`${API_URL}/api/actividades`);
                const result = await response.json();
                if (result.success && result.data) {
                    activities = result.data;
                    renderCalendar();
                }
            } catch (error) {
                console.error('Error cargando actividades:', error);
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let html = dayNames.map(day => `<div class="day-header">${day}</div>`).join('');

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);

                const isOtherMonth = cellDate.getMonth() !== month;
                const isToday = cellDate.getTime() === today.getTime();

                const dayActivities = activities.filter(act => {
                    if (!act.fechaInicio) return false;
                    const actDate = new Date(act.fechaInicio);
                    return actDate.toDateString() === cellDate.toDateString();
                });

                const eventsHtml = dayActivities.slice(0, 3).map(act => {
                    const category = (act.categoria || 'default').toLowerCase().replace(' ', '_');
                    return `<div class="event ${category}" onclick="showEvent('${act.id}')">${act.nombre}</div>`;
                }).join('');

                const moreCount = dayActivities.length > 3 ? `<div class="event default">+${dayActivities.length - 3} mas</div>` : '';

                html += `
                    <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}">
                        <div class="day-number">${cellDate.getDate()}</div>
                        ${eventsHtml}
                        ${moreCount}
                    </div>
                `;
            }

            document.getElementById('calendarGrid').innerHTML = html;
        }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function showEvent(id) {
            selectedActivity = activities.find(a => a.id === id);
            if (!selectedActivity) return;

            document.getElementById('eventTitle').textContent = selectedActivity.nombre;
            document.getElementById('eventCategory').textContent = selectedActivity.categoria || 'General';
            document.getElementById('eventDate').textContent = selectedActivity.fechaInicio ? new Date(selectedActivity.fechaInicio).toLocaleString() : 'Por definir';
            document.getElementById('eventLocation').textContent = selectedActivity.ubicacion || 'Por definir';
            document.getElementById('eventDescription').textContent = selectedActivity.descripcion || 'Sin descripcion';
            document.getElementById('eventVolunteers').textContent = `${selectedActivity.voluntariosInscritos || 0}/${selectedActivity.voluntariosRequeridos || '∞'}`;

            document.getElementById('btnInscribirse').style.display = token ? 'block' : 'none';
            document.getElementById('eventModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('active');
            selectedActivity = null;
        }

        async function inscribirse() {
            if (!token) {
                globalThis.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/inscripciones`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ actividadId: selectedActivity.id })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Inscripcion exitosa!');
                    closeModal();
                } else {
                    alert(result.message || 'Error al inscribirse');
                }
            } catch (error) {
                alert('Error de conexion');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            globalThis.location.href = '/login';
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        loadActivities();
    </script>
</body>
</html>
